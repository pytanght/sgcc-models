import numpy as np
import os, cv2, math, sys
from utils.baseconfig import ERRMSG
from .inference_common import nms_for_cls, get_main_tar, get_center_tar, get_center_tar_list, get_tar_in_box, get_nearest_tar, iou_calc1, iof_calc
from .inference_common import _get_line_by_houf, show_and_save_result, screen_by_class_score, _get_angle_by_lines, postprocess_nms_screen, get_core_of_array

CLASSES = ['基础类本体杂物堆积021_jc_bt_zwdj', '基础类本体构筑物021_jc_bt_gzw', '基础类本体树木021_jc_bt_sm', '基础类本体正常021_jc_bt_zc', '基础类本体立柱淹没021_jc_bt_lzym', '大尺寸金具类保护金具重锤正常021_dccjj_bhjjzc_zc', '大尺寸金具类保护金具重锤锈蚀021_dccjj_bhjjzc_xs', '大尺寸金具类保护金具防振锤正常021_dccjj_bhjjfzc_zc', '大尺寸金具类保护金具防振锤防振锤偏斜021_dccjj_bhjjfzc_px', '大尺寸金具类保护金具防振锤防振锤损坏021_dccjj_bhjjfzc_sh', '大尺寸金具类保护金具防振锤防振锤滑移021_dccjj_bhjjfzc_hy', '大尺寸金具类保护金具防振锤防振锤锈蚀021_dccjj_bhjjfzc_xs', '大尺寸金具类悬垂线夹船体偏移021_dccjj_xcxjct_py', '大尺寸金具类悬垂线夹船体挂板锈蚀021_dccjj_xcxjct_gbxs', '大尺寸金具类悬垂线夹船体正常021_dccjj_xcxjct_zc', '大尺寸金具类悬垂线夹船体锈蚀021_dccjj_xcxjct_xs', '大尺寸金具类悬垂线夹螺栓缺垫片021_dccjj_xcxjls_qdp', '大尺寸金具类耐张线夹压接管正常021_dccjj_nzxjyjg_zc', '大尺寸金具类耐张线夹压接管钢锚锈蚀021_dccjj_nzxjyjg_gmxs', '大尺寸金具类耐张线夹引流板垫片锈蚀021_dccjj_nzxjylb_dpxs', '大尺寸金具类耐张线夹引流板缺垫片021_dccjj_nzxjylb_qdp', '大尺寸金具类耐张线夹本体正常021_dccjj_nzxjbt_zc', '大尺寸金具类耐张线夹本体锈蚀021_dccjj_nzxjbt_xs', '大尺寸金具类联接金具U型挂环正常021_dccjj_ljjjuxgh_zc', '大尺寸金具类联接金具U型挂环锈蚀021_dccjj_ljjjuxgh_xs', '大尺寸金具类联接金具U型螺丝正常021_dccjj_ljjjuxls_zc', '大尺寸金具类联接金具U型螺丝锈蚀021_dccjj_ljjjuxls_xs', '大尺寸金具类联接金具延长环正常021_dccjj_ljjjych_zc', '大尺寸金具类联接金具延长环锈蚀021_dccjj_ljjjych_xs', '大尺寸金具类联接金具挂板正常021_dccjj_ljjjgb_zc', '大尺寸金具类联接金具挂板锈蚀021_dccjj_ljjjgb_xs', '大尺寸金具类联接金具球头挂环正常021_dccjj_ljjjqtgh_zc', '大尺寸金具类联接金具球头挂环锈蚀021_dccjj_ljjjqtgh_xs', '大尺寸金具类联接金具直角环正常021_dccjj_ljjjzjh_zc', '大尺寸金具类联接金具联板正常021_dccjj_ljjjlb_zc', '大尺寸金具类联接金具联板锈蚀021_dccjj_ljjjlb_xs', '大尺寸金具类联接金具调整板正常021_dccjj_ljjjtzb_zc', '大尺寸金具类联接金具调整板锈蚀021_dccjj_ljjjtzb_xs', '导地线类本体地线锈蚀021_ddx_bt_dxxs', '导地线类本体异物021_ddx_bt_yw', '导地线类本体损伤021_ddx_bt_ss', '导地线类本体松股021_ddx_bt_sg', '导地线类本体正常021_ddx_bt_zc', '小尺寸金具类垫片正常021_xccjj_dp_zc', '小尺寸金具类垫片缺垫片021_xccjj_dp_qdp', '小尺寸金具类螺母正常021_xccjj_lm_zc', '小尺寸金具类螺母螺栓松动021_xccjj_lm_lssd', '小尺寸金具类螺母螺栓缺螺母021_xccjj_lm_qlm', '小尺寸金具类螺母螺母松动021_xccjj_lm_lmsd', '小尺寸金具类螺母螺母锈蚀021_xccjj_lm_xs', '小尺寸金具类螺母防松帽松动021_xccjj_lm_fsmsd', '小尺寸金具类螺母防松帽缺失021_xccjj_lm_fsmqs', '小尺寸金具类销钉安装不到位021_xccjj_xd_azbdw', '小尺寸金具类销钉安装不规范021_xccjj_xd_azbgf', '小尺寸金具类销钉正常021_xccjj_xd_zc', '小尺寸金具类销钉螺栓缺销钉021_xccjj_xd_qx', '小尺寸金具类销钉螺栓销钉锈蚀021_xccjj_xd_xs', '小尺寸金具类销钉螺栓锈蚀021_xccjj_xd_lsxs', '小尺寸金具类销钉销钉脱出销钉安装不到位021_xccjj_xd_azbdw', '接地装置类本体引下线锈蚀021_jdzz_bt_yxxxs', '接地装置类本体接地体外露021_jdzz_bt_jdtwl', '接地装置类本体接地螺栓缺失021_jdzz_bt_jdlsqs', '杆塔类塔材正常021_gt_tc_zc', '杆塔类塔材锈蚀021_gt_tc_xs', '杆塔类塔身杆塔异物021_gt_ts_gtyw', '杆塔类塔身树枝021_gt_ts_sz', '杆塔类塔身正常021_gt_ts_zc', '杆塔类塔身蜂窝021_gt_ts_fw', '杆塔类塔身锈蚀021_gt_ts_xs', '杆塔类塔身鸟巢021_gt_ts_nc', '杆塔类拉线锈蚀021_gt_lx_xs', '杆塔类横担正常021_gt_hd_zc', '杆塔类横担锈蚀021_gt_hd_xs', '杆塔类爬梯正常021_gt_pt_zc', '杆塔类脚钉正常021_gt_jd_zc', '杆塔类脚钉锈蚀021_gt_jd_xs', '绝缘子类伞群正常021_jyz_sq_zc', '绝缘子类伞群破损021_jyz_sq_ps', '绝缘子类均压环均压环反装021_jyz_jyh_fz', '绝缘子类均压环均压环损坏021_jyz_jyh_sh', '绝缘子类均压环均压环移位021_jyz_jyh_yw', '绝缘子类均压环均压环脱落021_jyz_jyh_tl', '绝缘子类均压环均压环锈蚀021_jyz_jyh_xs', '绝缘子类均压环正常021_jyz_jyh_zc', '绝缘子类本体串倾斜021_jyz_bt_cqx', '绝缘子类本体正常021_jyz_bt_zc', '绝缘子类本体玻璃绝缘子自爆021_jyz_bt_zb', '绝缘子类本体瓷质绝缘子破损021_jyz_bt_ps', '绝缘子类本体瓷质绝缘子釉表面灼伤021_jyz_bt_ybmzs', '绝缘子类本体绝缘子污秽021_jyz_bt_wh', '绝缘子类本体钢帽锈蚀021_jyz_bt_gmxs', '通道类环境吊车021_td_hj_dc', '通道类环境塔吊021_td_hj_td', '通道类环境导线与建筑物距离不足021_td_hj_fw', '通道类环境导线与树木距离不足021_td_hj_sm', '通道类环境挖掘机021_td_hj_wjj', '通道类环境推土机021_td_hj_ttj', '通道类环境正常021_td_hj_zc', '通道类环境烟雾021_td_hj_yw', '附属设施类杆号牌杆号牌图文不清021_fsss_ghp_twbq', '附属设施类杆号牌杆号牌破损021_fsss_ghp_ps', '附属设施类杆号牌杆号牌遮挡021_fsss_ghp_zd', '附属设施类杆号牌正常021_fsss_ghp_zc', '附属设施类耦合地线锈蚀021_fsss_ohx_xs', '附属设施类色标牌正常021_fsss_sbp_zc', '附属设施类色标牌色标牌退色021_fsss_sbp_ts', '附属设施类警告牌标志牌图文不清021_fsss_jgp_twbq', '附属设施类警告牌标志牌破损021_fsss_jgp_ps', '附属设施类警告牌标志牌遮挡021_fsss_jgp_zd', '附属设施类警告牌正常021_fsss_jgp_zc', '附属设施类警告牌防鸟设施损坏021_fsss_jgp_fnsssh', '附属设施类计数器正常021_fsss_jsq_zc', '附属设施类避雷器正常021_fsss_blq_zc']
# 自动生成xml文件时的标签
cls_score_dict = {'基础类本体杂物堆积021_jc_bt_zwdj':0.30, '基础类本体构筑物021_jc_bt_gzw':0.30, '基础类本体树木021_jc_bt_sm':0.30, '基础类本体正常021_jc_bt_zc':0.30, '基础类本体立柱淹没021_jc_bt_lzym':0.30, '大尺寸金具类保护金具重锤正常021_dccjj_bhjjzc_zc':0.30, '大尺寸金具类保护金具重锤锈蚀021_dccjj_bhjjzc_xs':0.30, '大尺寸金具类保护金具防振锤正常021_dccjj_bhjjfzc_zc':0.30, '大尺寸金具类保护金具防振锤防振锤偏斜021_dccjj_bhjjfzc_px':0.30, '大尺寸金具类保护金具防振锤防振锤损坏021_dccjj_bhjjfzc_sh':0.30, '大尺寸金具类保护金具防振锤防振锤滑移021_dccjj_bhjjfzc_hy':0.30, '大尺寸金具类保护金具防振锤防振锤锈蚀021_dccjj_bhjjfzc_xs':0.30, '大尺寸金具类悬垂线夹船体偏移021_dccjj_xcxjct_py':0.30, '大尺寸金具类悬垂线夹船体挂板锈蚀021_dccjj_xcxjct_gbxs':0.30, '大尺寸金具类悬垂线夹船体正常021_dccjj_xcxjct_zc':0.30, '大尺寸金具类悬垂线夹船体锈蚀021_dccjj_xcxjct_xs':0.30, '大尺寸金具类悬垂线夹螺栓缺垫片021_dccjj_xcxjls_qdp':0.30, '大尺寸金具类耐张线夹压接管正常021_dccjj_nzxjyjg_zc':0.30, '大尺寸金具类耐张线夹压接管钢锚锈蚀021_dccjj_nzxjyjg_gmxs':0.30, '大尺寸金具类耐张线夹引流板垫片锈蚀021_dccjj_nzxjylb_dpxs':0.30, '大尺寸金具类耐张线夹引流板缺垫片021_dccjj_nzxjylb_qdp':0.30, '大尺寸金具类耐张线夹本体正常021_dccjj_nzxjbt_zc':0.30, '大尺寸金具类耐张线夹本体锈蚀021_dccjj_nzxjbt_xs':0.30, '大尺寸金具类联接金具U型挂环正常021_dccjj_ljjjuxgh_zc':0.30, '大尺寸金具类联接金具U型挂环锈蚀021_dccjj_ljjjuxgh_xs':0.30, '大尺寸金具类联接金具U型螺丝正常021_dccjj_ljjjuxls_zc':0.30, '大尺寸金具类联接金具U型螺丝锈蚀021_dccjj_ljjjuxls_xs':0.30, '大尺寸金具类联接金具延长环正常021_dccjj_ljjjych_zc':0.30, '大尺寸金具类联接金具延长环锈蚀021_dccjj_ljjjych_xs':0.30, '大尺寸金具类联接金具挂板正常021_dccjj_ljjjgb_zc':0.30, '大尺寸金具类联接金具挂板锈蚀021_dccjj_ljjjgb_xs':0.30, '大尺寸金具类联接金具球头挂环正常021_dccjj_ljjjqtgh_zc':0.30, '大尺寸金具类联接金具球头挂环锈蚀021_dccjj_ljjjqtgh_xs':0.30, '大尺寸金具类联接金具直角环正常021_dccjj_ljjjzjh_zc':0.30, '大尺寸金具类联接金具联板正常021_dccjj_ljjjlb_zc':0.30, '大尺寸金具类联接金具联板锈蚀021_dccjj_ljjjlb_xs':0.30, '大尺寸金具类联接金具调整板正常021_dccjj_ljjjtzb_zc':0.30, '大尺寸金具类联接金具调整板锈蚀021_dccjj_ljjjtzb_xs':0.30, '导地线类本体地线锈蚀021_ddx_bt_dxxs':0.30, '导地线类本体异物021_ddx_bt_yw':0.30, '导地线类本体损伤021_ddx_bt_ss':0.30, '导地线类本体松股021_ddx_bt_sg':0.30, '导地线类本体正常021_ddx_bt_zc':0.30, '小尺寸金具类垫片正常021_xccjj_dp_zc':0.30, '小尺寸金具类垫片缺垫片021_xccjj_dp_qdp':0.30, '小尺寸金具类螺母正常021_xccjj_lm_zc':0.30, '小尺寸金具类螺母螺栓松动021_xccjj_lm_lssd':0.30, '小尺寸金具类螺母螺栓缺螺母021_xccjj_lm_qlm':0.30, '小尺寸金具类螺母螺母松动021_xccjj_lm_lmsd':0.30, '小尺寸金具类螺母螺母锈蚀021_xccjj_lm_xs':0.30, '小尺寸金具类螺母防松帽松动021_xccjj_lm_fsmsd':0.30, '小尺寸金具类螺母防松帽缺失021_xccjj_lm_fsmqs':0.30, '小尺寸金具类销钉安装不到位021_xccjj_xd_azbdw':0.30, '小尺寸金具类销钉安装不规范021_xccjj_xd_azbgf':0.30, '小尺寸金具类销钉正常021_xccjj_xd_zc':0.30, '小尺寸金具类销钉螺栓缺销钉021_xccjj_xd_qx':0.30, '小尺寸金具类销钉螺栓销钉锈蚀021_xccjj_xd_xs':0.30, '小尺寸金具类销钉螺栓锈蚀021_xccjj_xd_lsxs':0.30, '小尺寸金具类销钉销钉脱出销钉安装不到位021_xccjj_xd_azbdw':0.30, '接地装置类本体引下线锈蚀021_jdzz_bt_yxxxs':0.30, '接地装置类本体接地体外露021_jdzz_bt_jdtwl':0.30, '接地装置类本体接地螺栓缺失021_jdzz_bt_jdlsqs':0.30, '杆塔类塔材正常021_gt_tc_zc':0.30, '杆塔类塔材锈蚀021_gt_tc_xs':0.30, '杆塔类塔身杆塔异物021_gt_ts_gtyw':0.30, '杆塔类塔身树枝021_gt_ts_sz':0.30, '杆塔类塔身正常021_gt_ts_zc':0.30, '杆塔类塔身蜂窝021_gt_ts_fw':0.30, '杆塔类塔身锈蚀021_gt_ts_xs':0.30, '杆塔类塔身鸟巢021_gt_ts_nc':0.30, '杆塔类拉线锈蚀021_gt_lx_xs':0.30, '杆塔类横担正常021_gt_hd_zc':0.30, '杆塔类横担锈蚀021_gt_hd_xs':0.30, '杆塔类爬梯正常021_gt_pt_zc':0.30, '杆塔类脚钉正常021_gt_jd_zc':0.30, '杆塔类脚钉锈蚀021_gt_jd_xs':0.30, '绝缘子类伞群正常021_jyz_sq_zc':0.30, '绝缘子类伞群破损021_jyz_sq_ps':0.30, '绝缘子类均压环均压环反装021_jyz_jyh_fz':0.30, '绝缘子类均压环均压环损坏021_jyz_jyh_sh':0.30, '绝缘子类均压环均压环移位021_jyz_jyh_yw':0.30, '绝缘子类均压环均压环脱落021_jyz_jyh_tl':0.30, '绝缘子类均压环均压环锈蚀021_jyz_jyh_xs':0.30, '绝缘子类均压环正常021_jyz_jyh_zc':0.30, '绝缘子类本体串倾斜021_jyz_bt_cqx':0.30, '绝缘子类本体正常021_jyz_bt_zc':0.30, '绝缘子类本体玻璃绝缘子自爆021_jyz_bt_zb':0.30, '绝缘子类本体瓷质绝缘子破损021_jyz_bt_ps':0.30, '绝缘子类本体瓷质绝缘子釉表面灼伤021_jyz_bt_ybmzs':0.30, '绝缘子类本体绝缘子污秽021_jyz_bt_wh':0.30, '绝缘子类本体钢帽锈蚀021_jyz_bt_gmxs':0.30, '通道类环境吊车021_td_hj_dc':0.30, '通道类环境塔吊021_td_hj_td':0.30, '通道类环境导线与建筑物距离不足021_td_hj_fw':0.30, '通道类环境导线与树木距离不足021_td_hj_sm':0.30, '通道类环境挖掘机021_td_hj_wjj':0.30, '通道类环境推土机021_td_hj_ttj':0.30, '通道类环境正常021_td_hj_zc':0.30, '通道类环境烟雾021_td_hj_yw':0.30, '附属设施类杆号牌杆号牌图文不清021_fsss_ghp_twbq':0.30, '附属设施类杆号牌杆号牌破损021_fsss_ghp_ps':0.30, '附属设施类杆号牌杆号牌遮挡021_fsss_ghp_zd':0.30, '附属设施类杆号牌正常021_fsss_ghp_zc':0.30, '附属设施类耦合地线锈蚀021_fsss_ohx_xs':0.30, '附属设施类色标牌正常021_fsss_sbp_zc':0.30, '附属设施类色标牌色标牌退色021_fsss_sbp_ts':0.30, '附属设施类警告牌标志牌图文不清021_fsss_jgp_twbq':0.30, '附属设施类警告牌标志牌破损021_fsss_jgp_ps':0.30, '附属设施类警告牌标志牌遮挡021_fsss_jgp_zd':0.30, '附属设施类警告牌正常021_fsss_jgp_zc':0.30, '附属设施类警告牌防鸟设施损坏021_fsss_jgp_fnsssh':0.30, '附属设施类计数器正常021_fsss_jsq_zc':0.30, '附属设施类避雷器正常021_fsss_blq_zc':0.30}


merge_nms_xjj = []
iou_thres_xjj = [0.25,]

# 模型识别完的后处理
def inference_postprocess(result, imgpath, detect_cls=[], cls_score={}, infer_stage=4):
    if isinstance(imgpath, str):
        img = cv2.imdecode(np.fromfile(imgpath,dtype=np.uint8), cv2.IMREAD_COLOR | cv2.IMREAD_IGNORE_ORIENTATION)
    else:
        img = imgpath
    if infer_stage == 0: # 返回所有缺陷类别(不含小金具类别)，阈值取0.05
        return result, [], ''
    cls_score_dict.update(cls_score)
    result = postprocess_nms_screen(result, CLASSES, cls_score_dict, merge_nms_xjj, iou_thres_xjj)
    return result, [], ''


